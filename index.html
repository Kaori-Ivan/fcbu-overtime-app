<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FCBU OT QR v2 clean（加班申報｜MVP）</title>

<!-- QRCode.js -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
:root{
  --bg:#eef3f8;
  --card:#ffffff;
  --blue:#5fa0e8;
  --blue-soft:#e9f2ff;
  --text:#0b1a33;
  --muted:#5b6f8f;
  --border:#c9dbf2;
  --danger:#ff6b6b;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:var(--bg);
  font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC",sans-serif;
  color:var(--text);
}

/* ===== Header ===== */
.header{
  margin:12px;
  padding:14px 20px;
  background:linear-gradient(135deg,#6aa8ee,#4a90e2);
  border-radius:18px;
  display:flex;
  align-items:center;
  gap:14px;
  color:#fff;
}
.logo{
  width:42px;height:42px;
  border-radius:10px;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  color:#d40000;
}

/* ===== Layout ===== */
.container{ max-width:1200px; margin:auto; padding:12px; }
.card{
  background:var(--card);
  border-radius:18px;
  padding:18px;
  margin-bottom:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
}
.label{ font-size:14px; color:#234; margin-bottom:6px; }
.muted{ color:var(--muted); font-size:13px; }

/* ===== Inputs ===== */
.input{
  width:100%;
  padding:16px;
  font-size:16px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#f2f8ff;
}
.row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.flex1{ flex:1; min-width: 220px; }

/* ===== Work Content ===== */
.work-wrap{
  background:var(--blue-soft);
  border-radius:18px;
  padding:14px;
}
.work-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;
}
.work-group{
  background:#e6f1ff;
  border-radius:16px;
  padding:12px;
}
.work-btn{
  background:#fff;
  border-radius:14px;
  padding:14px;
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
  border:2px solid transparent;
  cursor:pointer;
  user-select:none;
}
.work-btn.active{
  border-color:#6aa8ee;
  background:#eef6ff;
}
.work-num{
  width:28px;height:28px;
  border-radius:10px;
  background:#e6f1ff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  color:#2b6cb0;
}

/* ===== Buttons ===== */
.btn-row{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
}
button{
  padding:14px 18px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#f2f7ff;
  font-size:15px;
  cursor:pointer;
}
.btn-primary{
  background:#e6f1ff;
  border-color:#6aa8ee;
  font-weight:700;
}
.btn-danger{
  background:#ffecee;
  color:#c0392b;
  border-color:#ffb3b3;
}
.badge{
  background:#eef6ff;
  border-radius:999px;
  padding:6px 12px;
  font-size:13px;
  color:#345;
}
.badge.warn{ background:#fff2e6; color:#7a4a00; }
.badge.err{ background:#ffecee; color:#9c2f22; }

/* ===== QR area ===== */
.qr-wrap{
  display:grid;
  grid-template-columns: 1fr 260px;
  gap:14px;
  align-items:start;
}
.qr-box{
  width:260px;
  min-height:260px;
  border-radius:16px;
  border:1px dashed var(--border);
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.code{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  background:#f6f9ff;
  border:1px solid #e3ecff;
  border-radius:12px;
  padding:10px 12px;
  word-break:break-all;
}

/* ===== RWD ===== */
@media (max-width:900px){
  .work-grid{grid-template-columns:repeat(2,1fr);}
  .qr-wrap{grid-template-columns:1fr;}
  .qr-box{width:100%; min-height:240px;}
}
</style>
</head>

<body>
<div class="header">
  <div class="logo">K</div>
  <h2>FCBU 加班申報｜OT QR v2 clean（MVP）</h2>
</div>

<div class="container">

  <!-- 日期 / 時數 -->
  <div class="card">
    <div class="label">共用條件（同一天 / 同時數 / 同工作內容）</div>
    <div class="row">
      <div class="flex1">
        <div class="label">日期（YYMMDD）</div>
        <input id="inDate" class="input" placeholder="例如 260225">
        <div class="muted">預設今日，可手改</div>
      </div>
      <div class="flex1">
        <div class="label">加班時數（HOURS）</div>
        <input id="inHours" class="input" inputmode="decimal" placeholder="例如 4 或 2.5">
        <div class="muted">建議 0.5 為單位</div>
      </div>
      <div class="flex1">
        <div class="label">工作代碼（01–12）</div>
        <div class="input" style="display:flex;align-items:center;justify-content:space-between;">
          <span id="selWorkText" style="font-weight:700;">01</span>
          <span class="muted">點下方工作內容切換</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 工作內容（只輸出 01-12） -->
  <div class="card">
    <div class="label">工作內容（封包只放 01–12）</div>
    <div class="work-wrap">
      <div class="work-grid" id="workGrid">
        <!-- JS 生成 12 項 -->
      </div>
      <div class="muted" style="margin-top:10px;">
        封包內只存 <b>兩位數代碼</b>（01–12），中文名稱由 VBA/Excel 對照表還原。
      </div>
    </div>
  </div>

  <!-- 人員工號連續掃描 -->
  <div class="card">
    <div class="label">人員工號（連續掃描加入，用逗號區分）</div>
    <div class="row">
      <input id="inID" class="input flex1" placeholder="掃描或輸入工號後按 Enter（例如 C1900）">
      <button id="btnAdd" class="btn-primary">加入</button>
      <button id="btnUndo">刪除最後一位</button>
      <button id="btnClearIDs" class="btn-danger">清空人員</button>
      <span class="badge" id="badgeCount">人數：0</span>
    </div>
    <div style="margin-top:10px;">
      <div class="label">IDS（逗號清單）</div>
      <div id="idsText" class="code">（尚無人員）</div>
      <div class="muted" style="margin-top:8px;">自動去空白、去重複；工號內不要包含逗號。</div>
    </div>
  </div>

  <!-- 操作 -->
  <div class="card">
    <div class="btn-row">
      <button id="btnQR" class="btn-primary">輸出條碼（生成 QR）</button>
      <button id="btnClearAll">清除全部</button>
      <span class="badge" id="badgeLen">字串長度：0</span>
      <span class="badge" id="badgeLimit">上限：200（建議）</span>
      <span class="badge" id="badgeStatus">狀態：待生成</span>
    </div>
  </div>

  <!-- QR + Raw -->
  <div class="card">
    <div class="qr-wrap">
      <div>
        <div class="label">Raw 封包（D|H|W|IDS）</div>
        <div id="rawText" class="code">（尚未生成）</div>
        <div class="muted" style="margin-top:8px;">
          VBA：Split(text,"|") → D, H, W, IDS；再 Split(IDS,",") 得多人清單。
        </div>
      </div>
      <div>
        <div class="label">QR Code</div>
        <div id="qrBox" class="qr-box"></div>
      </div>
    </div>
  </div>

</div>

<script>
/** ===== Config ===== */
const MAX_QR_LEN = 200; // 現場穩定掃描建議值（可改成 250 / 300）
const WORK_NAMES = [
  "UNI-主線","UNI-支線","UNI-前置",
  "SP-主線","SP-前置","TCH/MVH",
  "AFS","ATO","ARMNF",
  "AECBEL","SSB","試作"
];

/** ===== Helpers ===== */
function pad2(n){ return String(n).padStart(2,"0"); }
function todayYYMMDD(){
  const d = new Date();
  const yy = String(d.getFullYear()).slice(-2);
  const mm = pad2(d.getMonth()+1);
  const dd = pad2(d.getDate());
  return `${yy}${mm}${dd}`;
}
function setStatus(text, kind="ok"){
  const el = document.getElementById("badgeStatus");
  el.textContent = `狀態：${text}`;
  el.classList.remove("warn","err");
  if(kind==="warn") el.classList.add("warn");
  if(kind==="err") el.classList.add("err");
}
function normalizeId(s){
  return (s||"").trim().replace(/\s+/g,""); // 去所有空白
}

/** ===== Elements ===== */
const elDate = document.getElementById("inDate");
const elHours = document.getElementById("inHours");
const elInID = document.getElementById("inID");
const elWorkGrid = document.getElementById("workGrid");
const elSelWorkText = document.getElementById("selWorkText");

const elIdsText = document.getElementById("idsText");
const elBadgeCount = document.getElementById("badgeCount");
const elBadgeLen = document.getElementById("badgeLen");
const elBadgeLimit = document.getElementById("badgeLimit");

const elRawText = document.getElementById("rawText");
const elQrBox = document.getElementById("qrBox");

/** ===== State ===== */
let selectedWork = "01";
let ids = []; // array of IDs, unique

/** ===== Init ===== */
elDate.value = todayYYMMDD();
elBadgeLimit.textContent = `上限：${MAX_QR_LEN}（建議）`;
renderWorkButtons();
updateIdsUI();
updatePacketPreview("");

/** ===== Work buttons ===== */
function renderWorkButtons(){
  // 12 項分 4 組*3（對齊你原本 layout）
  elWorkGrid.innerHTML = "";
  const groups = [0,1,2,3].map(()=>document.createElement("div"));
  groups.forEach(g=>{
    g.className = "work-group";
    elWorkGrid.appendChild(g);
  });

  for(let i=1;i<=12;i++){
    const idx = i-1;
    const code = pad2(i);
    const name = WORK_NAMES[idx] || `Work ${code}`;

    const btn = document.createElement("div");
    btn.className = "work-btn" + (code===selectedWork ? " active" : "");
    btn.dataset.work = code;

    btn.innerHTML = `<div class="work-num">${code}</div><div>${name}</div>`;
    btn.addEventListener("click", ()=>{
      selectedWork = code;
      elSelWorkText.textContent = selectedWork;
      // refresh active
      [...document.querySelectorAll(".work-btn")].forEach(x=>{
        x.classList.toggle("active", x.dataset.work === selectedWork);
      });
      setStatus(`已選工作 ${selectedWork}`);
    });

    groups[Math.floor(idx/3)].appendChild(btn);
  }
}

/** ===== IDs ===== */
function addId(value){
  const v = normalizeId(value);
  if(!v) return;

  if(v.includes(",")){
    alert("工號不可包含逗號 ,");
    return;
  }
  if(!ids.includes(v)){
    ids.push(v);
  }
  elInID.value = "";
  updateIdsUI();
  setStatus("已加入人員");
}

function undoLast(){
  if(ids.length>0){
    ids.pop();
    updateIdsUI();
    setStatus("已刪除最後一位", "warn");
  }
}

function clearIds(){
  ids = [];
  updateIdsUI();
  setStatus("已清空人員", "warn");
}

function updateIdsUI(){
  const text = ids.length ? ids.join(",") : "（尚無人員）";
  elIdsText.textContent = text;
  elBadgeCount.textContent = `人數：${ids.length}`;
}

/** ===== Packet / QR ===== */
function buildPacket(){
  const d = (elDate.value||"").trim();
  const h = (elHours.value||"").trim();
  const w = selectedWork;
  const idList = ids.join(",");

  if(!/^\d{6}$/.test(d)) throw new Error("日期需為 YYMMDD（6 碼，例如 260225）");
  if(!h || isNaN(Number(h))) throw new Error("加班時數 HOURS 需為數字（例如 4 或 2.5）");
  if(!w) throw new Error("工作代碼未選擇");
  if(ids.length===0) throw new Error("請至少加入 1 位人員工號");

  return `${d}|${h}|${w}|${idList}`;
}

function renderQR(text){
  elQrBox.innerHTML = "";
  new QRCode(elQrBox, {
    text,
    width: 220,
    height: 220,
    correctLevel: QRCode.CorrectLevel.M
  });
}

function updatePacketPreview(packet){
  elRawText.textContent = packet || "（尚未生成）";
  elBadgeLen.textContent = `字串長度：${packet ? packet.length : 0}`;

  if(!packet){
    setStatus("待生成");
    return;
  }
  if(packet.length > MAX_QR_LEN){
    setStatus(`超過上限（${packet.length}）`, "err");
  }else if(packet.length > Math.floor(MAX_QR_LEN*0.85)){
    setStatus(`接近上限（${packet.length}）`, "warn");
  }else{
    setStatus(`OK（${packet.length}）`);
  }
}

/** ===== Events ===== */
document.getElementById("btnAdd").addEventListener("click", ()=> addId(elInID.value));

elInID.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    addId(elInID.value);
  }
});

document.getElementById("btnUndo").addEventListener("click", undoLast);
document.getElementById("btnClearIDs").addEventListener("click", clearIds);

document.getElementById("btnQR").addEventListener("click", ()=>{
  try{
    const packet = buildPacket();
    updatePacketPreview(packet);

    if(packet.length > MAX_QR_LEN){
      alert(`封包長度 ${packet.length} 超過建議上限 ${MAX_QR_LEN}，為確保掃描穩定，已停止生成 QR。`);
      return;
    }
    renderQR(packet);
  }catch(err){
    alert(err.message || String(err));
  }
});

document.getElementById("btnClearAll").addEventListener("click", ()=>{
  elDate.value = todayYYMMDD();
  elHours.value = "";
  selectedWork = "01";
  elSelWorkText.textContent = selectedWork;
  ids = [];
  renderWorkButtons();
  updateIdsUI();
  updatePacketPreview("");
  elQrBox.innerHTML = "";
  setStatus("已清除全部", "warn");
});
</script>

</body>
</html>